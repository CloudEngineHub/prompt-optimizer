# 上下文集合导入导出测试（Normal Flow）

## 📖 测试概述
验证 ContextRepo 的“上下文集合”导入/导出在正常流程下的可用性与一致性。重点覆盖 DataManager 的导出到文件/剪贴板、从文件/剪贴板导入（replace 模式）、导入统计（含预定义变量剔除计数）以及导入后刷新恢复。

## 🎯 测试目标
- 确认上下文集合可成功导出到文件与剪贴板
- 确认上下文集合可从文件与剪贴板导入（replace 模式）
- 校验导入统计字段：imported/skipped/predefinedVariablesRemoved
- 导入后刷新页面，数据与 currentId 恢复为导入包指定状态

## 📋 前置条件
- [ ] 应用可正常启动
- [ ] 可打开“数据管理器/DataManager”弹窗
- [ ] 已有基础上下文数据，或能通过 ContextEditor 快速创建

---

## 🔧 测试步骤

### 步骤1：准备可识别的上下文数据
**AI执行指导：**
- 通过“对话管理 + 上下文编辑器”创建一个可辨识的上下文（2条消息+2个变量+1个工具可选）
- 示例（消息）：
  - system: `你是一个助手，任务={{task}}`
  - user: `请处理 {{task}}，场景={{scene}}`
- 示例（变量）：`task=导出测试`，`scene=正常流`
- 可选：工具 `get_weather`

**预期结果：**
- 对话区显示变量与（可选）工具数量徽章

**验证点：**
- [ ] 变量统计数量正确
- [ ]（可选）工具数量徽章显示

---

### 步骤2：导出上下文集合到文件
**AI执行指导：**
- 打开“数据管理”弹窗（图标"💾"/“数据管理”）
- 点击“导出上下文到文件”（Context Export → File）
- 等待下载完成

**预期结果：**
- 触发下载 `contexts-backup-YYYY-MM-DD.json`
- Toast 显示“已导出 X 个上下文集合到文件”

**验证点：**
- [ ] 下载文件存在且非空
- [ ] JSON 解析成功，包含 `type/context-bundle`、`version`、`currentId`、`contexts`

---

### 步骤3：导出上下文集合到剪贴板
**AI执行指导：**
- 在数据管理中点击“导出到剪贴板”（Context Export → Clipboard）
- 读取剪贴板内容为文本并解析

**预期结果：**
- 复制成功，Toast 显示“已导出 X 个上下文集合到剪贴板”
- JSON 结构与文件导出一致

**验证点：**
- [ ] 剪贴板内容非空且可解析为 JSON
- [ ] 结构字段完整：`type/version/currentId/contexts`

---

### 步骤4：构造带有预定义变量覆盖的导入包（用于校验剔除）
**AI执行指导：**
- 以“步骤2/3”的导出 JSON 为模板，选取其中一个 `contexts[i]`，在其 `variables` 中注入以下任一/多个键值（示例）：
  - `currentPrompt: "不应被保存"`
  - `originalPrompt: "不应被保存"`
  - `userQuestion: "不应被保存"`
- 确保 JSON 仍合法，保存为临时文件或复制到剪贴板

**预期结果：**
- 准备出一个“包含预定义变量名覆盖”的导入包

**验证点：**
- [ ] 文件或剪贴板中的上下文 JSON 可被解析
- [ ] 至少包含 1 个预定义变量键

---

### 步骤5：从文件导入上下文集合（replace 模式）
**AI执行指导：**
- 在数据管理弹窗中使用“上下文导入（文件）”按钮选择“步骤4”的临时文件
- 等待导入完成与 Toast 统计提示

**预期结果：**
- 成功导入，Toast 文案包含：
  - 导入数量（imported）
  - 跳过数量（skipped，如无错误可为0）
  - 剔除预定义变量覆盖数量（predefinedVariablesRemoved ≥ 1）
- 若应用在 Web 中，导入成功后可能触发页面刷新（或由父层在“全部数据导入”时触发刷新）；本上下文导入场景以不强制刷新为准。

**验证点：**
- [ ] 出现“成功：导入 X 个上下文，…剔除 Y 个预定义变量覆盖”的提示
- [ ] 导入后“上下文编辑器”中对应变量不包含注入的预定义键（如 `currentPrompt`）

---

### 步骤6：从剪贴板导入上下文集合（replace 模式）
**AI执行指导：**
- 点击“上下文导入（剪贴板）”，将“步骤4”的 JSON 放入剪贴板后执行
- 重复“预期结果/验证点”的校验

**预期结果：**
- 与“步骤5”一致，统计正确且预定义变量被剔除

**验证点：**
- [ ] 统计中的 `predefinedVariablesRemoved` 大于 0
- [ ] 变量页与预览不包含被禁止的键名

---

### 步骤7：导入后刷新恢复（可选）
**AI执行指导：**
- 手动刷新页面（或按 F5）
- 打开“上下文编辑器”，检查消息与变量是否与导入包一致
- 若导入包包含 `currentId` 指向特定上下文，验证当前上下文内容与之匹配

**预期结果：**
- 刷新后仍保持导入后的上下文集合与当前选择

**验证点：**
- [ ] 消息/变量与导入包一致
- [ ] 当前内容与 `currentId` 指向的一致

---

## 🧪 诊断建议（失败时）
- 导入失败：检查 JSON 结构是否满足 `type/context-bundle`、`version`、`currentId`、`contexts[]`
- 剔除计数为0：确认确实注入了预定义变量键（`currentPrompt/originalPrompt/userQuestion/iterateInput/lastOptimizedPrompt/conversationContext`）
- 刷新后不生效：确认是否需要等待 UI 的导入完成提示；如走“全部数据导入”流程，父层可能触发刷新

---

## ✅ 成功标准
- 文件与剪贴板导出均可用，结构正确
- 文件与剪贴板导入（replace）均成功，统计正确且预定义变量覆盖被剔除
- 刷新后状态保持，数据与 currentId 一致

