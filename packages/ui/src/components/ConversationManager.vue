<template>
  <NCard class="conversation-manager" size="small">
    <!-- Á¥ßÂáëÂûãÂ§¥ÈÉ®Ôºö‰∏ÄË°åÊòæÁ§∫Ê†áÈ¢ò„ÄÅÊ∂àÊÅØÊï∞ÈáèÂíåÊìç‰ΩúÊåâÈíÆ -->
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-3">
        <h3 class="text-base font-semibold">
          ‰∏ä‰∏ãÊñáÁÆ°ÁêÜ
        </h3>
        <NTag size="small" type="info">
          {{ t('conversation.messageCount', { count: messages.length }) }}
        </NTag>
        <!-- ÂèòÈáèÂíåÂ∑•ÂÖ∑ÁªüËÆ°Á¥ßÂáëÊòæÁ§∫ -->
        <div v-if="messages.length > 0" class="flex items-center gap-2 text-xs text-gray-500">
          <span 
            class="flex items-center gap-1 cursor-help"
            :title="allUsedVariables.length > 0 ? `‰ΩøÁî®ÁöÑÂèòÈáè: ${allUsedVariables.join(', ')}` : 'ÊöÇÊó†‰ΩøÁî®ÂèòÈáè'"
          >
            <svg class="w-3 h-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
            ÂèòÈáè: {{ allUsedVariables.length }}
          </span>
          <span v-if="allMissingVariables.length > 0" class="flex items-center gap-1 text-amber-600">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.996-.833-2.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
            Áº∫Â§±: {{ allMissingVariables.length }}
          </span>
          <!-- üÜï Â∑•ÂÖ∑Êï∞ÈáèÁªüËÆ° -->
          <span 
            class="flex items-center gap-1 cursor-help"
            :title="currentTools.length > 0 ? `‰ΩøÁî®ÁöÑÂ∑•ÂÖ∑: ${currentTools.map(t => t.function.name).join(', ')}` : 'ÊöÇÊó†‰ΩøÁî®Â∑•ÂÖ∑'"
          >
            <svg class="w-3 h-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Â∑•ÂÖ∑: {{ currentTools.length }}
          </span>
        </div>
      </div>
      
      <!-- Êìç‰ΩúÊåâÈíÆÁªÑ -->
      <div class="flex items-center gap-1">
        <!-- Âø´ÈÄüÊ®°Êùø‰∏ãÊãâËèúÂçï -->
        <NDropdown 
          :options="templateDropdownOptions"
          @select="handleTemplateDropdownSelect"
        >
          <NButton size="small" secondary>
            <template #icon>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
              </svg>
            </template>
            {{ t('conversation.quickTemplates') }}
          </NButton>
        </NDropdown>
        
        <!-- ÁºñËæëÊåâÈíÆ -->
        <NButton
          v-if="messages.length > 0"
          @click="openContextEditor"
          size="small"
          type="primary"
          title="Âú®ÂÖ®Â±èÁºñËæëÂô®‰∏≠ÁºñËæë‰∏ä‰∏ãÊñáÂíåÊèêÂèñÂèòÈáè"
        >
          <template #icon>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </template>
          ÁºñËæë
        </NButton>
        
        <!-- ÂØºÂÖ•ÊåâÈíÆ -->
        <NButton
          @click="showImportDialog = true"
          size="small"
          secondary
        >
          {{ t('conversation.import') }}
        </NButton>
        
        <!-- ÂØºÂá∫ÊåâÈíÆ -->
        <NButton
          v-if="messages.length > 0"
          @click="showExportDialog = true"
          size="small"
          secondary
        >
          {{ t('conversation.export') }}
        </NButton>
        
        <!-- ÂêåÊ≠•Âà∞ÊµãËØïÊåâÈíÆ -->
        <NButton
          v-if="showSyncToTest && messages.length > 0"
          @click="handleSyncToTest"
          size="small"
          type="primary"
          title="Â∞ÜÂΩìÂâç‰ºöËØùÂêåÊ≠•Âà∞ÊµãËØïÂå∫Âüü"
        >
          <template #icon>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m0-4l-4-4" />
            </svg>
          </template>
          ÂêåÊ≠•Âà∞ÊµãËØï
        </NButton>
        
        <!-- ÊäòÂè†/Â±ïÂºÄÊåâÈíÆ -->
        <NButton
          v-if="collapsible"
          @click="toggleCollapse"
          size="small"
          secondary
          :title="isCollapsed ? t('common.expand', 'Â±ïÂºÄ') : t('common.collapse', 'Êî∂Ëµ∑')"
        >
          <template #icon>
            <svg 
              class="w-3 h-3 transition-transform duration-200"
              :class="{ 'rotate-180': isCollapsed }"
              fill="none" 
              stroke="currentColor" 
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </template>
        </NButton>
      </div>
    </div>

    <!-- Ê∂àÊÅØÂàóË°®ÔºöÈôêÂà∂ÊúÄÂ§ßÈ´òÂ∫¶Âπ∂ÈõÜÊàêÊ∑ªÂä†ÂäüËÉΩ -->
    <div v-if="!isCollapsed" class="conversation-container" :style="containerStyle">
      <!-- ÊªöÂä®Ê∂àÊÅØÂàóË°® -->
      <div class="message-list" :class="{ 'has-messages': messages.length > 0 }">
        <div v-if="messages.length === 0" class="empty-state">
          <div class="text-center py-8 text-gray-500">
            <svg class="w-8 h-8 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.959 8.959 0 01-4.906-1.471L3 21l2.471-5.094A8.959 8.959 0 013 12c0-4.418 3.582-8 8-8s8 3.582 8 8z" />
            </svg>
            <p class="text-sm">{{ t('conversation.noMessages') }}</p>
          </div>
        </div>
        
        <div v-else>
          <ConversationMessageEditor
            v-for="(message, index) in messages"
            :key="`message-${index}`"
            :message="message"
            :index="index"
            :disabled="disabled"
            :can-move-up="index > 0"
            :can-move-down="index < messages.length - 1"
            :can-delete="messages.length > 1"
            :available-variables="availableVariables"
            :scan-variables="scanVariables"
            :is-predefined-variable="isPredefinedVariable"
            :replace-variables="replaceVariables"
            @update:message="updateMessage(index, $event)"
            @move-up="moveMessage(index, -1)"
            @move-down="moveMessage(index, 1)"
            @delete="deleteMessage(index)"
            @create-variable="handleCreateVariable"
            @open-variable-manager="handleOpenVariableManager"
          />
        </div>
      </div>
      
      <!-- ÈõÜÊàêÁöÑÊ∑ªÂä†Ê∂àÊÅØË°å -->
      <NCard size="small" :bordered="false" class="mt-2">
        <NSpace align="center" :wrap="false" size="small">
          <!-- Â∫èÂè∑ -->
          <div class="w-6 text-center">
            <NText depth="3" class="text-xs font-mono">
              #{{ messages.length + 1 }}
            </NText>
          </div>
          
          <!-- ËßíËâ≤ÈÄâÊã© -->
          <NSelect 
            v-model:value="newMessageRole" 
            :options="roleOptions"
            size="small"
            :disabled="disabled"
            style="width: 100px;"
          />
          
          <!-- Ê∑ªÂä†ÊåâÈíÆ -->
          <div class="flex-1">
            <NButton
              @click="addMessage"
              :disabled="disabled"
              type="primary"
              size="small"
              dashed
              block
            >
              <template #icon>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
              </template>
              {{ t('conversation.addMessage') }}
            </NButton>
          </div>
          
          <!-- Êìç‰ΩúÂå∫ÂüüÂç†‰Ωç -->
          <div class="w-16"></div>
        </NSpace>
      </NCard>
    </div>


    <!-- ÂØºÂá∫ÂØπËØùÊ°Ü -->
    <NModal 
      v-model:show="showExportDialog" 
      preset="dialog" 
      :title="t('conversation.exportTitle')"
      :show-icon="false"
      style="width: 600px"
    >
      <template #default>
        <NInput
          :value="exportData"
          readonly
          type="textarea"
          :autosize="{ minRows: 16, maxRows: 16 }"
          class="font-mono text-sm"
        />
      </template>
      <template #action>
        <div class="flex justify-end gap-2">
          <NButton @click="showExportDialog = false" type="default">
            {{ t('common.cancel') }}
          </NButton>
          <NButton @click="copyExportData" type="primary">
            {{ t('conversation.copyData') }}
          </NButton>
        </div>
      </template>
    </NModal>

    <!-- ÂØºÂÖ•ÂØπËØùÊ°Ü -->
    <NModal 
      v-model:show="showImportDialog" 
      preset="dialog" 
      :title="t('conversation.importTitle')"
      :show-icon="false"
      style="width: 600px"
    >
      <template #default>
        <!-- Ê†ºÂºèÈÄâÊã© -->
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">ÂØºÂÖ•Ê†ºÂºèÔºö</label>
          <NButtonGroup size="small">
            <NButton
              v-for="format in importFormats"
              :key="format.id"
              @click="selectedImportFormat = format.id"
              :type="selectedImportFormat === format.id ? 'primary' : 'default'"
              size="small"
            >
              {{ format.name }}
            </NButton>
          </NButtonGroup>
          <p class="text-xs text-gray-500 mt-2">
            {{ importFormats.find(f => f.id === selectedImportFormat)?.description }}
          </p>
        </div>

        <!-- Êñá‰ª∂‰∏ä‰º†ÊàñÊñáÊú¨ËæìÂÖ• -->
        <div class="mb-4">
          <div class="flex gap-2 mb-2">
            <input
              type="file"
              ref="fileInput"
              accept=".json,.txt"
              @change="handleFileUpload"
              class="hidden"
            >
            <NButton
              @click="$refs.fileInput?.click()"
              secondary
              size="small"
            >
              <template #icon>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
              </template>
              ÈÄâÊã©Êñá‰ª∂
            </NButton>
            <span class="text-sm text-gray-500">ÊàñÂú®‰∏ãÊñπÁ≤òË¥¥ÊñáÊú¨</span>
          </div>
        </div>

        <NInput
          v-model:value="importData"
          type="textarea"
          :autosize="{ minRows: 16, maxRows: 16 }"
          :placeholder="getImportPlaceholder()"
          class="font-mono text-sm"
        />
        
        <div v-if="importError" class="text-sm text-red-500 mt-2">
          {{ importError }}
        </div>
      </template>
      <template #action>
        <div class="flex justify-end gap-2">
          <NButton @click="showImportDialog = false" type="default">
            {{ t('common.cancel') }}
          </NButton>
          <NButton 
            @click="importMessages" 
            :disabled="!importData.trim()"
            type="primary"
          >
            {{ t('conversation.import') }}
          </NButton>
        </div>
      </template>
    </NModal>
    
    <!-- ÂÖ®Â±è‰∏ä‰∏ãÊñáÁºñËæëÂô® -->
    <div v-if="showContextEditor" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center" @click="handleContextEditorClose()">
      <div class="w-full h-full" @click.stop>
        <ContextEditor
          :initial-data="{
            messages: props.messages,
            tools: currentTools,
            metadata: {
              source: 'conversation_manager',
              timestamp: new Date().toISOString()
            }
          }"
          :available-vars="props.availableVariables"
          @close="handleContextEditorClose"
          @save="handleContextEditorClose"
          @create-variable="handleCreateVariable"
        />
      </div>
    </div>
  </NCard>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { useI18n } from 'vue-i18n'
import { NButton, NCard, NTag, NDropdown, NModal, NInput, NButtonGroup, NSelect, NSpace, NText } from 'naive-ui'
import { useClipboard } from '../composables/useClipboard'
import { useContextEditor } from '../composables/useContextEditor'
import ConversationMessageEditor from './ConversationMessageEditor.vue'
import ContextEditor from './ContextEditor.vue'
import type { ConversationMessage } from '../types/variable'
import type { ToolDefinition } from '../types/standard-prompt'
import { quickTemplateManager } from '../data/quickTemplates'

const { t, locale } = useI18n()
const { copyText } = useClipboard()
const contextEditor = useContextEditor()

interface Props {
  messages: ConversationMessage[]
  disabled?: boolean
  availableVariables?: Record<string, string>
  scanVariables?: (content: string) => string[]
  isPredefinedVariable?: (name: string) => boolean
  replaceVariables?: (content: string, variables?: Record<string, string>) => string
  showSyncToTest?: boolean // ÊòØÂê¶ÊòæÁ§∫ÂêåÊ≠•Âà∞ÊµãËØïÊåâÈíÆ
  optimizationMode?: 'system' | 'user' // ‰ºòÂåñÊ®°ÂºèÔºåÁî®‰∫éÂå∫ÂàÜÊ®°Êùø
  collapsible?: boolean // ÊòØÂê¶ÂèØÊäòÂè†
  maxHeight?: number // ÊúÄÂ§ßÈ´òÂ∫¶ÔºàÂÉèÁ¥†Ôºâ
  tools?: ToolDefinition[] // üÜï Â∑•ÂÖ∑ÂÆö‰πâÊîØÊåÅÔºàÂêëÂêéÂÖºÂÆπÔºâ
}

const props = withDefaults(defineProps<Props>(), {
  disabled: false,
  availableVariables: () => ({}),
  scanVariables: () => [],
  isPredefinedVariable: () => false,
  replaceVariables: (content: string) => content,
  showSyncToTest: false,
  optimizationMode: 'system',
  collapsible: false,
  maxHeight: undefined
})

const emit = defineEmits<{
  'update:messages': [messages: ConversationMessage[]]
  'create-variable': [name: string, defaultValue?: string]
  'open-variable-manager': [variableName: string]
  'sync-to-test': [syncData: { messages: ConversationMessage[], tools: ToolDefinition[] }]  // üÜï Êõ¥Êñ∞‰∏∫ÂåÖÂê´Â∑•ÂÖ∑ÁöÑÁªìÊûÑÂåñÊï∞ÊçÆ
  'update:tools': [tools: ToolDefinition[]]  // üÜï Â∑•ÂÖ∑Êõ¥Êñ∞‰∫ã‰ª∂ÔºàÂêëÂêéÂÖºÂÆπÔºâ
}>()

// Áä∂ÊÄÅ
const newMessageRole = ref<'system' | 'user' | 'assistant'>('user')
const showExportDialog = ref(false)
const showImportDialog = ref(false)
const showContextEditor = ref(false)
const importData = ref('')
const importError = ref('')

// ËßíËâ≤ÈÄâÊã©ÈÄâÈ°π
const roleOptions = computed(() => [
  { label: t('conversation.roles.system'), value: 'system' },
  { label: t('conversation.roles.user'), value: 'user' },
  { label: t('conversation.roles.assistant'), value: 'assistant' }
])

// üÜï Â∑•ÂÖ∑ÁÆ°ÁêÜÁä∂ÊÄÅÔºàÂêëÂêéÂÖºÂÆπÔºâ
const currentTools = ref<ToolDefinition[]>(props.tools || [])
const isCollapsed = ref(false) // ÊäòÂè†Áä∂ÊÄÅ
const selectedImportFormat = ref('conversation')

// Ê®°Êùø‰∏ãÊãâËèúÂçïÈÄâÈ°π
const templateDropdownOptions = computed(() => {
  const options = quickTemplates.value.map(template => ({
    label: t(`conversation.templates.${template.id}`),
    key: template.id,
    template
  }))
  
  // Ê∑ªÂä†ÂàÜÈöîÁ¨¶ÂíåÊ∏ÖÈô§ÈÄâÈ°π
  options.push({
    type: 'divider',
    key: 'divider'
  })
  
  options.push({
    label: t('conversation.clearAll'),
    key: 'clear',
    disabled: props.messages.length === 0
  })
  
  return options
})

// ÂØºÂÖ•Ê†ºÂºèÈÄâÈ°π
const importFormats = [
  {
    id: 'conversation',
    name: '‰ºöËØùÊ†ºÂºè',
    description: 'Ê†áÂáÜÁöÑ‰ºöËØùÊ∂àÊÅØÊ†ºÂºèÔºåÂåÖÂê´ role Âíå content Â≠óÊÆµ'
  },
  {
    id: 'langfuse',
    name: 'LangFuse',
    description: 'LangFuse ËøΩË∏™Êï∞ÊçÆÊ†ºÂºèÔºåËá™Âä®ÊèêÂèñÊ∂àÊÅØÂíåÂèòÈáè'
  },
  {
    id: 'openai',
    name: 'OpenAI',
    description: 'OpenAI API ËØ∑Ê±ÇÊ†ºÂºèÔºåÊîØÊåÅÂ∑•ÂÖ∑Ë∞ÉÁî®'
  },
  {
    id: 'smart',
    name: 'Êô∫ËÉΩËØÜÂà´',
    description: 'Ëá™Âä®Ê£ÄÊµãÊ†ºÂºèÂπ∂ËΩ¨Êç¢'
  }
]

// Âä®ÊÄÅÂø´ÈÄüÊ®°Êùø - Ê†πÊçÆ‰ºòÂåñÊ®°ÂºèÂíåËØ≠Ë®ÄËé∑Âèñ
const quickTemplates = computed(() => {
  const currentLanguage = locale.value || 'zh-CN'
  return quickTemplateManager.getTemplates(props.optimizationMode, currentLanguage)
})

// ÊäòÂè†ÊéßÂà∂
const toggleCollapse = () => {
  isCollapsed.value = !isCollapsed.value
}

// ÂÆπÂô®Ê†∑Âºè
const containerStyle = computed(() => {
  const style: Record<string, any> = {}
  
  if (props.maxHeight && !isCollapsed.value) {
    style.maxHeight = `${props.maxHeight}px`
    style.overflowY = 'auto'
  }
  
  return style
})

// ËÆ°ÁÆóÂ±ûÊÄß
const allUsedVariables = computed(() => {
  const variables = new Set<string>()
  props.messages.forEach(message => {
    const content = message?.content || ''
    if (content && props.scanVariables) {
      const messageVars = props.scanVariables(content) || []
      messageVars.forEach(v => variables.add(v))
    }
  })
  return Array.from(variables)
})

const allMissingVariables = computed(() => {
  return allUsedVariables.value.filter(variable => 
    props.availableVariables[variable] === undefined
  )
})

const exportData = computed(() => {
  const exportObj = {
    messages: props.messages,
    exportTime: new Date().toISOString(),
    totalMessages: props.messages.length,
    usedVariables: allUsedVariables.value,
    missingVariables: allMissingVariables.value
  }
  return JSON.stringify(exportObj, null, 2)
})

// ÊñπÊ≥ï
const updateMessage = (index: number, message: ConversationMessage) => {
  const newMessages = [...props.messages]
  newMessages[index] = message
  emit('update:messages', newMessages)
}

const moveMessage = (index: number, direction: number) => {
  const newIndex = index + direction
  if (newIndex < 0 || newIndex >= props.messages.length) return
  
  const newMessages = [...props.messages]
  const temp = newMessages[index]
  newMessages[index] = newMessages[newIndex]
  newMessages[newIndex] = temp
  
  emit('update:messages', newMessages)
}

const deleteMessage = (index: number) => {
  if (props.messages.length <= 1) return // Ëá≥Â∞ë‰øùÁïô‰∏ÄÊù°Ê∂àÊÅØ
  
  const newMessages = props.messages.filter((_, i) => i !== index)
  emit('update:messages', newMessages)
}

const addMessage = () => {
  const newMessage: ConversationMessage = {
    role: newMessageRole.value,
    content: ''
  }
  
  const newMessages = [...props.messages, newMessage]
  emit('update:messages', newMessages)
}

const applyTemplate = (template: any) => {
  emit('update:messages', [...template.messages])
}

// Â§ÑÁêÜÊ®°Êùø‰∏ãÊãâËèúÂçïÈÄâÊã©
const handleTemplateDropdownSelect = (key: string, option: any) => {
  if (key === 'clear') {
    clearAllMessages()
  } else if (option.template) {
    applyTemplate(option.template)
  }
}

const handleSyncToTest = () => {
  // üÜï ÂêåÊ≠•Ê∂àÊÅØÂíåÂ∑•ÂÖ∑Âà∞ÊµãËØïÈò∂ÊÆµ
  const syncData = {
    messages: [...props.messages],
    tools: [...currentTools.value]
  }
  emit('sync-to-test', syncData)
}

const clearAllMessages = () => {
  if (confirm(t('conversation.confirmClear'))) {
    emit('update:messages', [])
  }
}

const handleCreateVariable = (name: string) => {
  // Âü∫‰∫éÂèòÈáèÂêçÁîüÊàê‰∏Ä‰∏™ÂêàÁêÜÁöÑÈªòËÆ§ÂÄº
  let defaultValue = ''
  if (name.toLowerCase().includes('name')) {
    defaultValue = 'John Doe'
  } else if (name.toLowerCase().includes('request') || name.toLowerCase().includes('question')) {
    defaultValue = 'Your question here'
  } else if (name.toLowerCase().includes('description')) {
    defaultValue = 'Description here'
  } else {
    defaultValue = `Value for ${name}`
  }
  
  emit('create-variable', name, defaultValue)
}

const handleOpenVariableManager = (variableName: string) => {
  // ÂÖàÂàõÂª∫ÂèòÈáèÔºåÁÑ∂ÂêéÊâìÂºÄÂèòÈáèÁÆ°ÁêÜÂô®
  handleCreateVariable(variableName)
  // ÂèëÂá∫ÊâìÂºÄÂèòÈáèÁÆ°ÁêÜÂô®ÁöÑ‰∫ã‰ª∂
  emit('open-variable-manager', variableName)
}

const copyExportData = async () => {
  try {
    await copyText(exportData.value)
    showExportDialog.value = false
  } catch (error) {
    console.error('[ConversationManager] Failed to copy export data:', error)
  }
}

const importMessages = () => {
  try {
    let data: any
    
    // Ê†πÊçÆÈÄâÊã©ÁöÑÊ†ºÂºèÂ§ÑÁêÜÊï∞ÊçÆ
    switch (selectedImportFormat.value) {
      case 'smart':
        // ‰ΩøÁî®Êô∫ËÉΩÂØºÂÖ•
        const result = contextEditor.smartImport(JSON.parse(importData.value))
        if (result.success && result.data) {
          // ËΩ¨Êç¢‰∏∫‰ºöËØùÊ†ºÂºè
          const messages = result.data.messages.map(msg => ({
            role: msg.role as 'system' | 'user' | 'assistant',
            content: msg.content
          }))
          emit('update:messages', messages)
        } else {
          throw new Error(result.error || 'Êô∫ËÉΩÂØºÂÖ•Â§±Ë¥•')
        }
        break
        
      case 'langfuse':
        // LangFuse Ê†ºÂºèÂØºÂÖ•
        const langfuseResult = contextEditor.convertFromLangFuse(JSON.parse(importData.value))
        if (langfuseResult.success && langfuseResult.data) {
          const messages = langfuseResult.data.messages.map(msg => ({
            role: msg.role as 'system' | 'user' | 'assistant',
            content: msg.content
          }))
          emit('update:messages', messages)
        } else {
          throw new Error(langfuseResult.error || 'LangFuse ÂØºÂÖ•Â§±Ë¥•')
        }
        break
        
      case 'openai':
        // OpenAI Ê†ºÂºèÂØºÂÖ•
        const openaiResult = contextEditor.convertFromOpenAI(JSON.parse(importData.value))
        if (openaiResult.success && openaiResult.data) {
          const messages = openaiResult.data.messages.map(msg => ({
            role: msg.role as 'system' | 'user' | 'assistant',
            content: msg.content
          }))
          emit('update:messages', messages)
        } else {
          throw new Error(openaiResult.error || 'OpenAI ÂØºÂÖ•Â§±Ë¥•')
        }
        break
        
      case 'conversation':
      default:
        // Ê†áÂáÜ‰ºöËØùÊ†ºÂºè
        data = JSON.parse(importData.value)
        
        if (!Array.isArray(data.messages)) {
          throw new Error('Invalid format: messages must be an array')
        }
        
        // È™åËØÅÊ∂àÊÅØÊ†ºÂºè
        for (const message of data.messages) {
          if (!message.role || !['system', 'user', 'assistant'].includes(message.role)) {
            throw new Error(`Invalid message role: ${message.role}`)
          }
          if (typeof message.content !== 'string') {
            throw new Error('Invalid message content: must be string')
          }
        }
        
        emit('update:messages', data.messages)
        break
    }
    
    importData.value = ''
    importError.value = ''
    showImportDialog.value = false
    
    console.log('[ConversationManager] Messages imported successfully')
  } catch (error) {
    importError.value = error.message || t('conversation.importError')
    console.error('[ConversationManager] Failed to import messages:', error)
  }
}

// Êñá‰ª∂‰∏ä‰º†Â§ÑÁêÜ
const handleFileUpload = (event: Event) => {
  const file = (event.target as HTMLInputElement).files?.[0]
  if (!file) return
  
  const reader = new FileReader()
  reader.onload = (e) => {
    importData.value = e.target?.result as string
  }
  reader.readAsText(file)
}

// Ëé∑ÂèñÂØºÂÖ•Âç†‰ΩçÁ¨¶
const getImportPlaceholder = () => {
  switch (selectedImportFormat.value) {
    case 'langfuse':
      return 'LangFuse ËøΩË∏™Êï∞ÊçÆÔºå‰æãÂ¶ÇÔºö\n{\n  "input": {\n    "messages": [...]\n  },\n  "output": {...}\n}'
    case 'openai':
      return 'OpenAI API ËØ∑Ê±ÇÊ†ºÂºèÔºå‰æãÂ¶ÇÔºö\n{\n  "messages": [...],\n  "model": "gpt-4",\n  "tools": [...]\n}'
    case 'smart':
      return 'Á≤òË¥¥‰ªªÊÑèÊîØÊåÅÊ†ºÂºèÁöÑ JSON Êï∞ÊçÆÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®ËØÜÂà´'
    default:
      return 'Ê†áÂáÜ‰ºöËØùÊ†ºÂºèÔºå‰æãÂ¶ÇÔºö\n{\n  "messages": [\n    {"role": "system", "content": "..."},\n    {"role": "user", "content": "..."}\n  ]\n}'
  }
}

// ÊâìÂºÄ‰∏ä‰∏ãÊñáÁºñËæëÂô®
const openContextEditor = () => {
  // ËΩ¨Êç¢ÂΩìÂâçÊ∂àÊÅØ‰∏∫Ê†áÂáÜÊ†ºÂºè
  const standardData = {
    messages: props.messages.map(msg => ({
      role: msg.role,
      content: msg.content
    })),
    metadata: {
      source: 'conversation_manager',
      variables: props.availableVariables || {}
    }
  }
  
  contextEditor.setData(standardData)
  showContextEditor.value = true
}

// ÂÖ≥Èó≠‰∏ä‰∏ãÊñáÁºñËæëÂô®Âπ∂Â§ÑÁêÜÁªìÊûú
const handleContextEditorClose = (updatedData?: any) => {
  showContextEditor.value = false
  
  if (updatedData && updatedData.messages) {
    // ËΩ¨Êç¢Âõû‰ºöËØùÊ∂àÊÅØÊ†ºÂºè
    const messages = updatedData.messages.map((msg: any) => ({
      role: msg.role as 'system' | 'user' | 'assistant',
      content: msg.content
    }))
    emit('update:messages', messages)
    
    // üÜï Â§ÑÁêÜÂ∑•ÂÖ∑Êï∞ÊçÆÊõ¥Êñ∞ÔºàÂêëÂêéÂÖºÂÆπÔºâ
    if (updatedData.tools) {
      currentTools.value = [...updatedData.tools]
      emit('update:tools', currentTools.value)
    }
    
    // Â¶ÇÊûúÊúâÊñ∞ÂèòÈáèÔºåÂèëÂá∫ÂàõÂª∫ÂèòÈáè‰∫ã‰ª∂
    if (updatedData.metadata?.variables) {
      const existingVars = new Set(Object.keys(props.availableVariables || {}))
      const newVars = Object.keys(updatedData.metadata.variables).filter(
        name => !existingVars.has(name)
      )
      
      newVars.forEach(name => {
        emit('create-variable', name, updatedData.metadata.variables[name])
      })
    }
  }
}

// ÁõëÂê¨Ê∂àÊÅØÂèòÂåñÔºåÈáçÁΩÆÂØºÂÖ•ÈîôËØØ
watch(() => props.messages, () => {
  importError.value = ''
}, { deep: true })

// üÜï ÁõëÂê¨Â∑•ÂÖ∑Êï∞ÊçÆÂèòÂåñÔºàÂêëÂêéÂÖºÂÆπÔºâ
watch(() => props.tools, (newTools) => {
  if (newTools) {
    currentTools.value = [...newTools]
  }
}, { deep: true, immediate: true })
</script>

<style scoped>
/* ConversationManager specific styles - using centralized theme system */
.conversation-container {
  /* ÈôêÂà∂Êï¥‰∏™‰ºöËØùÁÆ°ÁêÜÂå∫ÂüüÁöÑÊúÄÂ§ßÈ´òÂ∫¶ */
  max-height: 40vh;
  min-height: 120px;
  display: flex;
  flex-direction: column;
}

.message-list {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
  scrollbar-width: thin;
  scrollbar-color: #cbd5e0 transparent;
}

.message-list::-webkit-scrollbar {
  width: 6px;
}

.message-list::-webkit-scrollbar-track {
  background: transparent;
}

.message-list::-webkit-scrollbar-thumb {
  background: #cbd5e0;
  border-radius: 3px;
}

.message-list::-webkit-scrollbar-thumb:hover {
  background: #a0aec0;
}

.message-list.has-messages {
  border-bottom: 1px solid #e5e7eb;
}

/* ÈõÜÊàêÁöÑÊ∑ªÂä†Ê∂àÊÅØË°å - ‰ΩøÁî® Pure Naive UI */

.dark .message-list::-webkit-scrollbar-thumb {
  background: #4b5563;
}

.dark .message-list::-webkit-scrollbar-thumb:hover {
  background: #6b7280;
}

.modal-overlay {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50;
}

.modal-content {
  background-color: white;
  backdrop-filter: blur(4px);
  border-radius: 0.75rem;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  border: 1px solid #d1d5db;
  padding: 1rem;
}

.dark .modal-content {
  background-color: #111827;
  border-color: #4b5563;
}
</style>
