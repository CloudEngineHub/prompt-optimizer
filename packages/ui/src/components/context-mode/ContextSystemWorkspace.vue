<template>
    <NFlex
        justify="space-between"
        :style="{
            display: 'flex',
            flexDirection: 'row',
            width: '100%',
            'max-height': '100%',
            gap: '16px',
        }"
    >
        <!-- Â∑¶‰æßÔºö‰ºòÂåñÂå∫Âüü -->
        <NFlex
            vertical
            :style="{
                flex: 1,
                overflow: 'auto',
                height: '100%',
            }"
        >
            <!-- ÊèêÁ§∫ËØçËæìÂÖ•Èù¢Êùø -->
            <NCard
                :style="{
                    flexShrink: 0,
                    minHeight: '200px',
                }"
            >
                <InputPanelUI
                    :modelValue="prompt"
                    @update:modelValue="emit('update:prompt', $event)"
                    :label="t('promptOptimizer.originalPrompt')"
                    :placeholder="
                        t('promptOptimizer.originalPromptPlaceholder')
                    "
                    :model-label="t('promptOptimizer.optimizeModel')"
                    :template-label="t('promptOptimizer.templateLabel')"
                    :button-text="t('promptOptimizer.optimize')"
                    :loading-text="t('common.loading')"
                    :loading="isOptimizing"
                    :disabled="isOptimizing"
                    :show-preview="true"
                    @submit="emit('optimize')"
                    @configModel="emit('config-model')"
                    @open-preview="emit('open-input-preview')"
                >
                    <template #model-select>
                        <slot name="optimize-model-select"></slot>
                    </template>
                    <template #template-select>
                        <slot name="template-select"></slot>
                    </template>
                </InputPanelUI>
            </NCard>

            <!-- ‰ºöËØùÁÆ°ÁêÜÂô® (Á≥ªÁªüÊ®°Âºè‰∏ìÂ±û) -->
            <NCard
                :style="{ flexShrink: 0, overflow: 'auto' }"
                content-style="padding: 0;"
            >
                <ConversationManager
                    :messages="optimizationContext"
                    @update:messages="
                        emit('update:optimizationContext', $event)
                    "
                    :available-variables="availableVariables"
                    :scan-variables="scanVariables"
                    :optimization-mode="optimizationMode"
                    context-mode="system"
                    :tool-count="toolCount"
                    @open-variable-manager="emit('open-variable-manager')"
                    @open-context-editor="emit('open-context-editor')"
                    :collapsible="true"
                    :max-height="300"
                />
            </NCard>

            <!-- ‰ºòÂåñÁªìÊûúÈù¢Êùø -->
            <NCard
                :style="{
                    flex: 1,
                    minHeight: '200px',
                    overflow: 'hidden',
                }"
                content-style="height: 100%; max-height: 100%; overflow: hidden;"
            >
                <PromptPanelUI
                    :optimized-prompt="optimizedPrompt"
                    @update:optimizedPrompt="
                        emit('update:optimizedPrompt', $event)
                    "
                    :reasoning="optimizedReasoning"
                    :original-prompt="prompt"
                    :is-optimizing="isOptimizing"
                    :is-iterating="isIterating"
                    :selectedIterateTemplate="selectedIterateTemplate"
                    @update:selectedIterateTemplate="
                        emit('update:selectedIterateTemplate', $event)
                    "
                    :versions="versions"
                    :current-version-id="currentVersionId"
                    :optimization-mode="optimizationMode"
                    :services="services"
                    :advanced-mode-enabled="true"
                    :show-preview="true"
                    @iterate="emit('iterate', $event)"
                    @openTemplateManager="emit('open-template-manager', $event)"
                    @switchVersion="emit('switch-version', $event)"
                    @save-favorite="emit('save-favorite', $event)"
                    @open-preview="emit('open-prompt-preview')"
                />
            </NCard>
        </NFlex>

        <!-- Âè≥‰æßÔºöÊµãËØïÂå∫Âüü -->
        <NFlex
            vertical
            :style="{
                flex: 1,
                overflow: 'auto',
                height: '100%',
                gap: '12px',
            }"
        >
            <!-- ÊµãËØïÂå∫ÂüüÊìç‰ΩúÊ†è -->
            <NCard size="small" :style="{ flexShrink: 0 }">
                <NFlex justify="space-between" align="center">
                    <!-- Â∑¶‰æßÔºöÂå∫ÂüüÊ†áËØÜ -->
                    <NFlex align="center" :size="8">
                        <NText strong>{{ $t("test.areaTitle") }}</NText>
                        <NTag type="info" size="small">
                            <template #icon><span>‚öôÔ∏è</span></template>
                            {{ $t("contextMode.system.label") }}
                        </NTag>
                    </NFlex>

                    <!-- Âè≥‰æßÔºöÂø´Êç∑Êìç‰ΩúÊåâÈíÆ -->
                    <NFlex :size="8">
                        <NButton
                            size="small"
                            quaternary
                            @click="emit('open-global-variables')"
                            :title="$t('contextMode.actions.globalVariables')"
                        >
                            <template #icon><span>üìä</span></template>
                            <span v-if="!isMobile">{{
                                $t("contextMode.actions.globalVariables")
                            }}</span>
                        </NButton>
                    </NFlex>
                </NFlex>
            </NCard>

            <!-- ÊµãËØïÂå∫Âüü‰∏ªÂÜÖÂÆπ -->
            <NCard
                :style="{ flex: 1, overflow: 'auto' }"
                content-style="height: 100%; max-height: 100%; overflow: hidden;"
            >
                <TestAreaPanel
                    ref="testAreaPanelRef"
                    :optimization-mode="optimizationMode"
                    context-mode="system"
                    :optimized-prompt="optimizedPrompt"
                    :is-test-running="isTestRunning"
                    :global-variables="globalVariables"
                    :predefined-variables="predefinedVariables"
                    :testContent="testContent"
                    @update:testContent="emit('update:testContent', $event)"
                    :isCompareMode="isCompareMode"
                    @update:isCompareMode="emit('update:isCompareMode', $event)"
                    :enable-compare-mode="true"
                    :enable-fullscreen="true"
                    :input-mode="inputMode"
                    :control-bar-layout="controlBarLayout"
                    :button-size="buttonSize"
                    :conversation-max-height="conversationMaxHeight"
                    :show-original-result="true"
                    :result-vertical-layout="resultVerticalLayout"
                    @test="handleTestWithVariables"
                    @compare-toggle="emit('compare-toggle')"
                    @open-variable-manager="emit('open-variable-manager')"
                    @open-preview="emit('open-test-preview')"
                    @variable-change="
                        (name: string, value: string) => emit('variable-change', name, value)
                    "
                    @save-to-global="
                        (name: string, value: string) => emit('save-to-global', name, value)
                    "
                >
                    <!-- Ê®°ÂûãÈÄâÊã©ÊèíÊßΩ -->
                    <template #model-select>
                        <slot name="test-model-select"></slot>
                    </template>

                    <!-- ÁªìÊûúÊòæÁ§∫ÊèíÊßΩ -->
                    <template #original-result>
                        <slot name="original-result"></slot>
                    </template>

                    <template #optimized-result>
                        <slot name="optimized-result"></slot>
                    </template>

                    <template #single-result>
                        <slot name="single-result"></slot>
                    </template>
                </TestAreaPanel>
            </NCard>
        </NFlex>
    </NFlex>
</template>

<script setup lang="ts">
import { ref } from 'vue'

import { useI18n } from "vue-i18n";
import { NCard, NFlex, NButton, NText, NTag } from "naive-ui";
import { useBreakpoints } from "@vueuse/core";
import InputPanelUI from "../InputPanel.vue";
import PromptPanelUI from "../PromptPanel.vue";
import TestAreaPanel from "../TestAreaPanel.vue";
import ConversationManager from "./ConversationManager.vue";
import type { OptimizationMode, ConversationMessage } from "../../types";
import type {
    IServices,
    PromptRecord,
    Template,
} from "@prompt-optimizer/core";
import type { TestAreaPanelInstance } from "../types/test-area";
import type { IteratePayload, SaveFavoritePayload } from "../../types/workspace";

// ÂìçÂ∫îÂºèÊñ≠ÁÇπ
const breakpoints = useBreakpoints({
    mobile: 640,
    tablet: 1024,
});
const isMobile = breakpoints.smaller("mobile");

// Props ÂÆö‰πâ (ÁßªÈô§ contextModeÔºåÂõ†‰∏∫Âõ∫ÂÆö‰∏∫ system)
interface Props {
    // Ê†∏ÂøÉÁä∂ÊÄÅ
    prompt: string;
    optimizedPrompt: string;
    optimizedReasoning?: string;
    optimizationMode: OptimizationMode;

    // ‰ºòÂåñÁä∂ÊÄÅ
    isOptimizing: boolean;
    isIterating: boolean;
    isTestRunning?: boolean;

    // ÁâàÊú¨ÁÆ°ÁêÜ
    versions: PromptRecord[];
    currentVersionId: string | null;
    selectedIterateTemplate: Template | null;

    // ‰∏ä‰∏ãÊñáÊï∞ÊçÆ (Á≥ªÁªüÊ®°Âºè‰∏ìÂ±û)
    optimizationContext: ConversationMessage[];
    toolCount: number;

    // ÊµãËØïÊï∞ÊçÆ
    testContent: string;
    isCompareMode: boolean;

    // ÂèòÈáèÊï∞ÊçÆ
    globalVariables: Record<string, string>;
    predefinedVariables: Record<string, string>;
    availableVariables: Record<string, string>;
    scanVariables: (content: string) => string[];

    // ÊúçÂä°
    services: IServices | null;

    // ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄÈÖçÁΩÆ
    inputMode?: "compact" | "normal";
    controlBarLayout?: "default" | "compact" | "minimal";
    buttonSize?: "small" | "medium" | "large";
    conversationMaxHeight?: number;
    resultVerticalLayout?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
    optimizedReasoning: "",
    isTestRunning: false,
    inputMode: "normal",
    controlBarLayout: "default",
    buttonSize: "medium",
    conversationMaxHeight: 300,
    resultVerticalLayout: false,
});

// Emits ÂÆö‰πâ
const emit = defineEmits<{
    // Êï∞ÊçÆÊõ¥Êñ∞
    "update:prompt": [value: string];
    "update:optimizedPrompt": [value: string];
    "update:selectedIterateTemplate": [value: Template | null];
    "update:optimizationContext": [value: ConversationMessage[]];
    "update:testContent": [value: string];
    "update:isCompareMode": [value: boolean];

    // Êìç‰Ωú‰∫ã‰ª∂
    optimize: [];
    iterate: [payload: IteratePayload];
    test: [testVariables: Record<string, string>]; // üÜï ‰º†ÈÄíÊµãËØïÂèòÈáè
    "compare-toggle": [];
    "switch-version": [version: PromptRecord];
    "save-favorite": [data: SaveFavoritePayload];

    // ÊâìÂºÄÈù¢Êùø/ÁÆ°ÁêÜÂô®
    "open-global-variables": [];
    "open-variable-manager": [];
    "open-context-editor": [tab?: string];
    "open-template-manager": [type?: string];
    "config-model": [];

    // È¢ÑËßàÁõ∏ÂÖ≥
    "open-input-preview": [];
    "open-prompt-preview": [];
    "open-test-preview": [];

    // ÂèòÈáèÁÆ°ÁêÜ
    "variable-change": [name: string, value: string];
    "save-to-global": [name: string, value: string];
}>();

const { t } = useI18n();

// üÜï TestAreaPanel ÂºïÁî®
const testAreaPanelRef = ref<TestAreaPanelInstance | null>(null);

// üÜï Â§ÑÁêÜÊµãËØï‰∫ã‰ª∂Âπ∂Ëé∑ÂèñÊµãËØïÂèòÈáè
const handleTestWithVariables = async () => {
    // ‰ªé ref Ëé∑ÂèñÊµãËØïÂèòÈáè
    const testVariables = testAreaPanelRef.value?.getVariableValues?.() || {};

    // Ëß¶ÂèëÊµãËØï‰∫ã‰ª∂Ôºå‰º†ÈÄíÊµãËØïÂèòÈáèÁªô App.vue
    emit('test', testVariables);
};

// Êö¥Èú≤ TestAreaPanel ÂºïÁî®ÁªôÁà∂ÁªÑ‰ª∂ÔºàÁî®‰∫éÂ∑•ÂÖ∑Ë∞ÉÁî®Á≠âÈ´òÁ∫ßÂäüËÉΩÔºâ
defineExpose({
    testAreaPanelRef
});
</script>
