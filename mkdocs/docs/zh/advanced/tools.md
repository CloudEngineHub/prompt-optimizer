# 工具调用功能（高级模式）

工具调用功能让AI模型能够调用外部函数来完成特定任务，大大扩展了AI的能力边界。支持数学计算、数据查询、API调用等复杂操作。

## 🔧 工具调用概述

工具调用（Function Calling）是现代AI模型的高级功能，允许AI主动调用预定义的外部工具来获取信息、执行计算或完成复杂任务。

### 核心优势

- **能力扩展** - 让AI突破纯文本生成的限制
- **实时信息** - 获取最新数据和动态内容
- **精确计算** - 执行复杂数学运算和数据处理
- **外部集成** - 连接各种API和外部服务

## 📋 支持的模型

### 主流模型支持

- **OpenAI** - GPT-4, GPT-3.5-turbo 等支持函数调用的模型
- **Gemini** - Gemini Pro 等支持函数调用的模型
- **DeepSeek** - 支持函数调用的DeepSeek模型
- **自定义模型** - 符合OpenAI函数调用标准的模型

### 兼容性检查

启用工具调用前，系统会自动检查当前模型是否支持函数调用功能，不兼容的模型会显示相应提示。

## 🛠️ 工具定义和配置（在上下文编辑器中）

### 创建工具定义

#### 1. 访问工具管理
- 在高级模式下找到"工具管理"入口
- 或通过设置页面进入工具配置
- 点击"新增工具"开始创建

#### 2. 定义工具函数

```json
{
  "name": "get_weather",
  "description": "获取指定城市的天气信息",
  "parameters": {
    "type": "object",
    "properties": {
      "city": {
        "type": "string",
        "description": "城市名称"
      },
      "unit": {
        "type": "string",
        "enum": ["celsius", "fahrenheit"],
        "description": "温度单位"
      }
    },
    "required": ["city"]
  }
}
```

#### 3. 工具实现配置
- **执行端点** - 定义工具的实际执行逻辑
- **认证设置** - 配置API密钥或认证信息
- **超时配置** - 设置工具调用的超时时间
- **错误处理** - 定义失败时的处理策略

### 数量徽章与导出结构

- 对话区顶部展示“工具数量”徽章（toolCount）
- 在“上下文编辑器 → 导出（标准格式）”导出的 JSON 中包含 `tools[]`

### 内置工具模板

#### 常用工具模板

**数学计算器**
```json
{
  "name": "calculate",
  "description": "执行数学运算",
  "parameters": {
    "type": "object",
    "properties": {
      "expression": {
        "type": "string",
        "description": "数学表达式，如：2+3*4"
      }
    }
  }
}
```

**时间日期工具**
```json
{
  "name": "get_current_time",
  "description": "获取当前时间",
  "parameters": {
    "type": "object",
    "properties": {
      "format": {
        "type": "string",
        "description": "时间格式，如：YYYY-MM-DD HH:mm:ss"
      },
      "timezone": {
        "type": "string",
        "description": "时区，如：Asia/Shanghai"
      }
    }
  }
}
```

**文本处理工具**
```json
{
  "name": "text_analyzer",
  "description": "分析文本内容",
  "parameters": {
    "type": "object",
    "properties": {
      "text": {
        "type": "string",
        "description": "要分析的文本内容"
      },
      "analysis_type": {
        "type": "string",
        "enum": ["sentiment", "keywords", "summary"],
        "description": "分析类型"
      }
    }
  }
}
```

## 🎯 工具调用测试（高级模式）

### 在对话中使用工具

#### 1. 准备工具调用提示词

```
你是一个智能助手，可以调用工具来获取信息和完成任务。
请帮我查询北京的天气情况，并计算如果温度是摄氏度，
转换为华氏度是多少。
```

#### 2. 启用工具调用功能

在模型配置中：
- ✅ 启用函数调用功能
- 选择要使用的工具集合
- 配置工具调用参数
- 设置并发调用限制

#### 3. 执行和监控

- 发送包含工具调用需求的提示词
- 观察AI如何分析并选择合适的工具
- 查看工具调用的参数传递
- 监控工具执行结果和AI的后续响应

### 工具调用流程

#### 完整调用流程

1. **需求识别** - AI分析用户请求，识别需要调用的工具
2. **参数提取** - AI从用户输入中提取工具所需参数
3. **工具调用** - 系统执行工具并返回结果
4. **结果集成** - AI将工具结果整合到最终回复中

#### 调用示例

```
用户: 帮我查一下上海明天的天气

AI分析: 需要调用天气查询工具
↓
工具调用: get_weather(city="上海", date="明天")
↓
工具返回: {"temperature": 25, "condition": "晴朗", "humidity": 60}
↓
AI回复: 根据查询结果，上海明天天气晴朗，温度25°C，湿度60%...
```

## 🐛 工具调用调试

### 调用日志

#### 详细日志记录
- **调用时间** - 精确的调用时间戳
- **工具名称** - 被调用的工具标识
- **输入参数** - 传递给工具的完整参数
- **输出结果** - 工具返回的结果数据
- **执行时间** - 工具执行耗时统计
- **错误信息** - 失败时的详细错误描述

#### 日志查看和分析
- 实时查看调用过程
- 按时间、工具、状态筛选
- 导出日志用于深度分析
- 设置日志保留策略

### 参数验证

#### 自动验证机制
- **类型检查** - 验证参数类型是否正确
- **必填验证** - 检查必需参数是否提供
- **格式验证** - 验证参数格式是否符合要求
- **范围检查** - 验证数值是否在允许范围内

#### 验证错误处理
- 详细的错误提示信息
- 建议修正方案
- 自动参数格式化（可选）
- 智能默认值填充

### 错误处理

#### 常见错误类型
1. **网络错误** - 工具服务不可达
2. **认证失败** - API密钥无效或过期
3. **参数错误** - 传递的参数不符合要求
4. **超时错误** - 工具执行时间过长
5. **权限错误** - 没有调用特定工具的权限

#### 错误处理策略
- **自动重试** - 对于临时性错误进行重试
- **降级处理** - 使用替代工具或方法
- **用户通知** - 向用户报告错误并提供建议
- **日志记录** - 记录错误详情供后续分析

### 性能监控

#### 关键指标
- **成功率** - 工具调用成功的百分比
- **平均响应时间** - 工具执行的平均耗时
- **并发调用数** - 同时执行的工具调用数量
- **资源使用率** - CPU、内存等资源消耗

#### 性能优化建议
- 避免频繁调用耗时工具
- 实现工具结果缓存机制
- 优化工具并发执行策略
- 定期清理过期的调用记录

## 💡 使用最佳实践

### 工具设计原则

#### 1. 单一职责
- 每个工具专注完成一个特定任务
- 避免功能过于复杂的"万能工具"
- 保持工具接口简洁明了

#### 2. 可复用性
- 设计通用性强的工具参数
- 支持多种使用场景
- 提供灵活的配置选项

#### 3. 健壮性
- 完善的错误处理机制
- 输入数据的严格验证
- 优雅的异常恢复策略

### 安全考虑

#### 权限控制
- 限制工具的访问权限
- 验证调用者身份
- 审计敏感操作记录

#### 数据保护
- 避免在工具间传递敏感信息
- 对API调用进行加密传输
- 定期清理临时数据

#### 资源限制
- 设置工具调用频率限制
- 控制并发调用数量
- 监控资源使用情况

---

**相关链接**：
- [变量管理](variables.md) - 在工具调用中使用变量
- [上下文管理](context.md) - 在多轮对话中管理工具调用上下文
- [使用案例](../examples/creative-writing.md) - 工具调用在创意写作中的实际应用案例
